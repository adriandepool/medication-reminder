<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Control de Medicamentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }
      .calendar-day {
        min-height: 80px;
      }
      .completed-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
      <header class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-teal-600">
          Mi Pastillero Digital
        </h1>
        <p class="text-gray-600 mt-2">
          Gestiona tus medicamentos y recordatorios de forma sencilla.
        </p>
      </header>

      <!-- Sección de Medicamentos -->
      <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">Mis Medicamentos</h2>
          <button
            id="addMedBtn"
            class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition-colors"
          >
            + Agregar
          </button>
        </div>
        <div id="medicationList" class="space-y-3">
          <!-- Los medicamentos se insertarán aquí dinámicamente -->
          <p id="empty-state" class="text-center text-gray-500 py-4">
            Aún no has agregado medicamentos.
          </p>
        </div>
      </div>

      <!-- Sección de Calendario -->
      <div class="bg-white p-6 rounded-2xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
          <button
            id="prevMonth"
            class="p-2 rounded-full hover:bg-gray-200 transition-colors"
          >
            &lt;
          </button>
          <h2 id="currentMonthYear" class="text-xl font-semibold"></h2>
          <button
            id="nextMonth"
            class="p-2 rounded-full hover:bg-gray-200 transition-colors"
          >
            &gt;
          </button>
        </div>
        <div class="calendar-grid text-center font-semibold text-gray-600 mb-2">
          <div>Dom</div>
          <div>Lun</div>
          <div>Mar</div>
          <div>Mié</div>
          <div>Jue</div>
          <div>Vie</div>
          <div>Sáb</div>
        </div>
        <div id="calendar" class="calendar-grid">
          <!-- El calendario se generará aquí -->
        </div>
      </div>
    </div>

    <!-- Modal para Agregar/Editar Medicamento -->
    <div
      id="medModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all scale-95 opacity-0"
        id="medModalContent"
      >
        <h3 id="modalTitle" class="text-2xl font-bold mb-6 text-center">
          Agregar Medicamento
        </h3>
        <form id="medForm">
          <input type="hidden" id="medId" />
          <div class="mb-4">
            <label for="medName" class="block text-gray-700 font-semibold mb-2"
              >Nombre del Medicamento</label
            >
            <input
              type="text"
              id="medName"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
              required
            />
          </div>
          <div class="mb-4">
            <label for="medTime" class="block text-gray-700 font-semibold mb-2"
              >Hora de toma</label
            >
            <input
              type="time"
              id="medTime"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
              required
            />
          </div>
          <div class="mb-6">
            <label for="medColor" class="block text-gray-700 font-semibold mb-2"
              >Color del Recordatorio</label
            >
            <input
              type="color"
              id="medColor"
              class="w-full h-10 px-1 py-1 border border-gray-300 rounded-lg cursor-pointer"
              value="#22c55e"
              required
            />
          </div>
          <div class="flex justify-end space-x-4">
            <button
              type="button"
              id="cancelBtn"
              class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition-colors"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-lg transition-colors"
            >
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal de Confirmación de Toma -->
    <div
      id="confirmationModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center transform transition-all scale-95 opacity-0"
        id="confirmationModalContent"
      >
        <input type="hidden" id="confirmMedId" />
        <h3 class="text-2xl font-bold mb-4">¡Hora de tu medicina!</h3>
        <p id="confirmMedText" class="text-gray-600 mb-6 text-lg"></p>
        <div class="flex justify-center space-x-4">
          <button
            id="confirmTakenBtn"
            class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg transition-colors text-lg"
          >
            ¡Tomada!
          </button>
          <button
            id="confirmSkipBtn"
            class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition-colors"
          >
            Omitir
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Historial del Día -->
    <div
      id="historyModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all scale-95 opacity-0"
        id="historyModalContent"
      >
        <h3 id="historyModalTitle" class="text-2xl font-bold mb-4 text-center">
          Historial del Día
        </h3>
        <div id="historyModalList" class="space-y-3 max-h-64 overflow-y-auto">
          <!-- El historial se insertará aquí dinámicamente -->
        </div>
        <div class="flex justify-end mt-6">
          <button
            type="button"
            id="closeHistoryBtn"
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition-colors"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Confirmar Borrado -->
    <div
      id="deleteConfirmModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center transform transition-all scale-95 opacity-0"
        id="deleteConfirmModalContent"
      >
        <h3 class="text-2xl font-bold mb-4 text-red-600">
          Confirmar Eliminación
        </h3>
        <p id="deleteConfirmText" class="text-gray-600 mb-6 text-lg"></p>
        <div class="flex justify-center space-x-4">
          <button
            id="cancelDeleteBtn"
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition-colors"
          >
            Cancelar
          </button>
          <button
            id="confirmDeleteBtn"
            class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition-colors"
          >
            Eliminar
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Elementos del DOM
        const addMedBtn = document.getElementById("addMedBtn");
        const medModal = document.getElementById("medModal");
        const medModalContent = document.getElementById("medModalContent");
        const cancelBtn = document.getElementById("cancelBtn");
        const medForm = document.getElementById("medForm");
        const medicationList = document.getElementById("medicationList");
        const modalTitle = document.getElementById("modalTitle");
        const medIdInput = document.getElementById("medId");
        const medNameInput = document.getElementById("medName");
        const medTimeInput = document.getElementById("medTime");
        const medColorInput = document.getElementById("medColor");
        const emptyState = document.getElementById("empty-state");

        // Modal de confirmación
        const confirmationModal = document.getElementById("confirmationModal");
        const confirmationModalContent = document.getElementById(
          "confirmationModalContent"
        );
        const confirmMedText = document.getElementById("confirmMedText");
        const confirmTakenBtn = document.getElementById("confirmTakenBtn");
        const confirmSkipBtn = document.getElementById("confirmSkipBtn");
        const confirmMedIdInput = document.getElementById("confirmMedId");

        // Modal de historial
        const historyModal = document.getElementById("historyModal");
        const historyModalContent = document.getElementById(
          "historyModalContent"
        );
        const historyModalTitle = document.getElementById("historyModalTitle");
        const historyModalList = document.getElementById("historyModalList");
        const closeHistoryBtn = document.getElementById("closeHistoryBtn");

        // Modal de confirmación de borrado
        const deleteConfirmModal =
          document.getElementById("deleteConfirmModal");
        const deleteConfirmModalContent = document.getElementById(
          "deleteConfirmModalContent"
        );
        const deleteConfirmText = document.getElementById("deleteConfirmText");
        const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
        const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

        // Calendario
        const calendarEl = document.getElementById("calendar");
        const currentMonthYearEl = document.getElementById("currentMonthYear");
        const prevMonthBtn = document.getElementById("prevMonth");
        const nextMonthBtn = document.getElementById("nextMonth");

        // Estado de la aplicación
        let medications = JSON.parse(localStorage.getItem("medications")) || [];
        let completedMeds =
          JSON.parse(localStorage.getItem("completedMeds")) || {};
        let currentDate = new Date();
        let notificationQueue = [];

        // --- Lógica de Modales ---
        const openModal = (modal, content) => {
          modal.classList.remove("hidden");
          setTimeout(() => {
            content.classList.remove("scale-95", "opacity-0");
          }, 10);
        };

        const closeModal = (modal, content) => {
          content.classList.add("scale-95", "opacity-0");
          setTimeout(() => {
            modal.classList.add("hidden");
            if (modal === confirmationModal) {
              processNotificationQueue(); // Procesa la siguiente notificación en la cola
            }
          }, 200);
        };

        // Abrir modal de agregar medicamento
        addMedBtn.addEventListener("click", () => {
          modalTitle.textContent = "Agregar Medicamento";
          medForm.reset();
          medColorInput.value = "#22c55e";
          medIdInput.value = "";
          openModal(medModal, medModalContent);
        });

        // Cerrar modales
        cancelBtn.addEventListener("click", () =>
          closeModal(medModal, medModalContent)
        );
        confirmSkipBtn.addEventListener("click", () =>
          closeModal(confirmationModal, confirmationModalContent)
        );
        closeHistoryBtn.addEventListener("click", () =>
          closeModal(historyModal, historyModalContent)
        );
        cancelDeleteBtn.addEventListener("click", () =>
          closeModal(deleteConfirmModal, deleteConfirmModalContent)
        );
        medModal.addEventListener("click", (e) => {
          if (e.target === medModal) closeModal(medModal, medModalContent);
        });
        historyModal.addEventListener("click", (e) => {
          if (e.target === historyModal)
            closeModal(historyModal, historyModalContent);
        });
        deleteConfirmModal.addEventListener("click", (e) => {
          if (e.target === deleteConfirmModal)
            closeModal(deleteConfirmModal, deleteConfirmModalContent);
        });

        // --- Lógica de Medicamentos (CRUD) ---
        const renderMedications = () => {
          medicationList.innerHTML = "";
          if (medications.length === 0) {
            medicationList.appendChild(emptyState);
            emptyState.style.display = "block";
          } else {
            emptyState.style.display = "none";
            medications
              .sort((a, b) => a.time.localeCompare(b.time))
              .forEach((med) => {
                const div = document.createElement("div");
                div.className =
                  "flex justify-between items-center bg-gray-50 p-3 rounded-lg border";
                div.innerHTML = `
                            <div class="flex items-center">
                                <span class="w-4 h-4 rounded-full mr-3" style="background-color: ${
                                  med.color || "#22c55e"
                                };"></span>
                                <div>
                                    <p class="font-semibold text-teal-700">${
                                      med.name
                                    }</p>
                                    <p class="text-sm text-gray-500">${
                                      med.time
                                    }</p>
                                </div>
                            </div>
                            <div class="space-x-2 flex items-center">
                                <button data-id="${
                                  med.id
                                }" class="edit-btn text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-blue-50 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                                </button>
                                <button data-id="${
                                  med.id
                                }" class="delete-btn text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        `;
                medicationList.appendChild(div);
              });
          }
        };

        medForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const id = medIdInput.value;
          const medData = {
            name: medNameInput.value,
            time: medTimeInput.value,
            color: medColorInput.value,
          };

          if (id) {
            // Editar
            medications = medications.map((med) =>
              med.id == id ? { ...med, ...medData } : med
            );
          } else {
            // Crear
            medData.id = Date.now();
            medications.push(medData);
          }

          localStorage.setItem("medications", JSON.stringify(medications));
          renderMedications();
          closeModal(medModal, medModalContent);
        });

        medicationList.addEventListener("click", (e) => {
          const editBtn = e.target.closest(".edit-btn");
          const deleteBtn = e.target.closest(".delete-btn");

          if (editBtn) {
            const id = editBtn.dataset.id;
            const medToEdit = medications.find((med) => med.id == id);
            if (medToEdit) {
              modalTitle.textContent = "Editar Medicamento";
              medIdInput.value = medToEdit.id;
              medNameInput.value = medToEdit.name;
              medTimeInput.value = medToEdit.time;
              medColorInput.value = medToEdit.color || "#22c55e";
              openModal(medModal, medModalContent);
            }
          }

          if (deleteBtn) {
            const id = deleteBtn.dataset.id;
            const medToDelete = medications.find((med) => med.id == id);
            if (medToDelete) {
              deleteConfirmText.innerHTML = `¿Estás seguro de que quieres eliminar <strong>${medToDelete.name}</strong>?`;
              confirmDeleteBtn.dataset.id = id; // Store id in the button
              openModal(deleteConfirmModal, deleteConfirmModalContent);
            }
          }
        });

        confirmDeleteBtn.addEventListener("click", () => {
          const id = confirmDeleteBtn.dataset.id;
          medications = medications.filter((med) => med.id != id);
          localStorage.setItem("medications", JSON.stringify(medications));
          renderMedications();
          closeModal(deleteConfirmModal, deleteConfirmModalContent);
        });

        const markMedAsTaken = (medId) => {
          const medTaken = medications.find((med) => med.id == medId);
          if (!medTaken) return;

          const now = new Date();
          const today = `${now.getFullYear()}-${(now.getMonth() + 1)
            .toString()
            .padStart(2, "0")}-${now.getDate().toString().padStart(2, "0")}`;
          const timeTaken = now.toLocaleTimeString("es-ES", {
            hour: "2-digit",
            minute: "2-digit",
          });

          if (!completedMeds[today]) {
            completedMeds[today] = [];
          }

          if (!completedMeds[today].some((m) => m.id == medId)) {
            completedMeds[today].push({
              id: medId,
              color: medTaken.color,
              name: medTaken.name,
              timeTaken: timeTaken,
            });
          }
          localStorage.setItem("completedMeds", JSON.stringify(completedMeds));
          renderCalendar();
        };

        // --- Lógica de Notificaciones ---
        const checkMedicationTime = () => {
          const now = new Date();
          const currentTime = `${now
            .getHours()
            .toString()
            .padStart(2, "0")}:${now.getMinutes().toString().padStart(2, "0")}`;

          const lastCheckDate = localStorage.getItem("lastNotificationDate");
          const todayStr = `${now.getFullYear()}-${(now.getMonth() + 1)
            .toString()
            .padStart(2, "0")}-${now.getDate().toString().padStart(2, "0")}`;

          if (lastCheckDate !== todayStr) {
            localStorage.setItem("notifiedMedsToday", JSON.stringify([]));
            localStorage.setItem("lastNotificationDate", todayStr);
          }

          let notifiedMedsToday =
            JSON.parse(localStorage.getItem("notifiedMedsToday")) || [];

          const medsToNotify = medications.filter(
            (med) =>
              med.time === currentTime && !notifiedMedsToday.includes(med.id)
          );

          if (medsToNotify.length > 0) {
            medsToNotify.forEach((med) => {
              notificationQueue.push(med); // Agrega a la cola
              notifiedMedsToday.push(med.id);
            });
            localStorage.setItem(
              "notifiedMedsToday",
              JSON.stringify(notifiedMedsToday)
            );
            processNotificationQueue(); // Procesa la cola
          }
        };

        const processNotificationQueue = () => {
          // Solo muestra un modal si no hay otro abierto y si hay elementos en la cola
          if (
            confirmationModal.classList.contains("hidden") &&
            notificationQueue.length > 0
          ) {
            const med = notificationQueue.shift(); // Saca el primer elemento
            showNotification(med);
          }
        };

        const showNotification = (med) => {
          const notificationText = `Es hora de tomar tu ${med.name}.`;

          if (Notification.permission === "granted") {
            new Notification("Recordatorio de Medicamento", {
              body: notificationText,
              icon: "https://cdn-icons-png.flaticon.com/512/893/893309.png",
            });
          }

          // Mostrar modal de confirmación
          confirmMedIdInput.value = med.id;
          confirmMedText.textContent = `¿Ya tomaste tu ${med.name}?`;
          openModal(confirmationModal, confirmationModalContent);
        };

        confirmTakenBtn.addEventListener("click", () => {
          const medId = confirmMedIdInput.value;
          markMedAsTaken(medId);
          closeModal(confirmationModal, confirmationModalContent);
        });

        // --- Lógica del Calendario ---
        const showDayHistory = (dateStr) => {
          const date = new Date(dateStr + "T00:00:00");
          const options = {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          };
          historyModalTitle.textContent = `Historial del ${date.toLocaleDateString(
            "es-ES",
            options
          )}`;

          const medsForDay = completedMeds[dateStr] || [];
          historyModalList.innerHTML = "";

          if (medsForDay.length > 0) {
            medsForDay
              .sort((a, b) => a.timeTaken.localeCompare(b.timeTaken))
              .forEach((med) => {
                const div = document.createElement("div");
                div.className =
                  "flex items-center justify-between p-2 bg-gray-50 rounded";
                div.innerHTML = `
                            <div class="flex items-center">
                                <span class="completed-dot mr-3" style="background-color: ${med.color};"></span>
                                <span>${med.name}</span>
                            </div>
                            <span class="font-semibold text-gray-600">${med.timeTaken} hs</span>
                        `;
                historyModalList.appendChild(div);
              });
          } else {
            historyModalList.innerHTML =
              '<p class="text-center text-gray-500">No se registraron tomas este día.</p>';
          }

          openModal(historyModal, historyModalContent);
        };

        const renderCalendar = () => {
          calendarEl.innerHTML = "";
          const month = currentDate.getMonth();
          const year = currentDate.getFullYear();

          currentMonthYearEl.textContent = `${currentDate.toLocaleString(
            "es-ES",
            { month: "long" }
          )} ${year}`;

          const firstDayOfMonth = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();

          for (let i = 0; i < firstDayOfMonth; i++) {
            calendarEl.innerHTML += `<div class="bg-gray-50 rounded"></div>`;
          }

          for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement("div");
            dayEl.className = "calendar-day p-2 border rounded text-center";

            const dayStr = `${year}-${(month + 1)
              .toString()
              .padStart(2, "0")}-${day.toString().padStart(2, "0")}`;
            const today = new Date();
            if (
              day === today.getDate() &&
              month === today.getMonth() &&
              year === today.getFullYear()
            ) {
              dayEl.classList.add("bg-teal-100", "font-bold");
            }

            let dayContent = `<div>${day}</div>`;

            if (completedMeds[dayStr] && completedMeds[dayStr].length > 0) {
              dayEl.classList.add(
                "cursor-pointer",
                "hover:bg-gray-100",
                "transition-colors"
              );
              dayEl.addEventListener("click", () => showDayHistory(dayStr));

              let dotsHTML =
                '<div class="mt-1 flex justify-center items-center space-x-1">';
              completedMeds[dayStr].forEach((completed) => {
                dotsHTML += `<span class="completed-dot" style="background-color: ${completed.color};"></span>`;
              });
              dotsHTML += "</div>";
              dayContent += dotsHTML;
            }
            dayEl.innerHTML = dayContent;
            calendarEl.appendChild(dayEl);
          }
        };

        prevMonthBtn.addEventListener("click", () => {
          currentDate.setMonth(currentDate.getMonth() - 1);
          renderCalendar();
        });

        nextMonthBtn.addEventListener("click", () => {
          currentDate.setMonth(currentDate.getMonth() + 1);
          renderCalendar();
        });

        // --- Inicialización ---
        const initialize = () => {
          renderMedications();
          renderCalendar();
          if (Notification.permission !== "granted") {
            Notification.requestPermission();
          }
          setInterval(checkMedicationTime, 15000); // Revisa cada 15 segundos
          checkMedicationTime(); // Revisa al cargar la página
        };

        initialize();
      });
    </script>
  </body>
</html>
