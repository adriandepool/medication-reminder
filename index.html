<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Control de Medicamentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }
      .calendar-day {
        min-height: 80px;
      }
      .completed-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
      }
      .day-checkbox:checked + label {
        background-color: #14b8a6; /* teal-500 */
        color: white;
        border-color: #0f766e; /* teal-600 */
      }
    </style>
  </head>
  <body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
      <header class="text-center mb-8 relative">
        <h1
          class="text-3xl md:text-4xl font-bold text-teal-600 dark:text-teal-400"
        >
          Mi Pastillero Digital
        </h1>
        <p class="text-gray-600 dark:text-gray-400 mt-2">
          Gestiona tus medicamentos y recordatorios de forma sencilla.
        </p>
        <div class="absolute top-0 left-0">
          <button
            id="theme-toggle"
            class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-bold p-2 rounded-full transition-colors"
            title="Cambiar Tema"
          >
            <svg
              id="theme-icon-light"
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
              ></path>
            </svg>
            <svg
              id="theme-icon-dark"
              class="w-6 h-6 hidden"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
              ></path>
            </svg>
          </button>
        </div>
        <div class="absolute top-0 right-0 flex space-x-2">
          <button
            id="backupBtn"
            class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-bold p-2 rounded-full transition-colors"
            title="Crear Copia de Seguridad (Exportar)"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"
              ></path>
            </svg>
          </button>
          <button
            id="restoreBtn"
            class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-bold p-2 rounded-full transition-colors"
            title="Restaurar Copia de Seguridad (Importar)"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"
              ></path>
            </svg>
          </button>
          <button
            id="exportPdfBtn"
            class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-bold p-2 rounded-full transition-colors"
            title="Exportar a PDF"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              ></path>
            </svg>
          </button>
          <input type="file" id="importFile" class="hidden" accept=".json" />
        </div>
      </header>

      <!-- Sección de Medicamentos -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg mb-8">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">Mis Medicamentos</h2>
          <button
            id="addMedBtn"
            class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition-colors"
          >
            + Agregar
          </button>
        </div>
        <div id="medicationList" class="space-y-3">
          <!-- Los medicamentos se insertarán aquí dinámicamente -->
          <p
            id="empty-state"
            class="text-center text-gray-500 dark:text-gray-400 py-4"
          >
            Aún no has agregado medicamentos.
          </p>
        </div>
      </div>

      <!-- Sección de Calendario -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
          <button
            id="prevMonth"
            class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
          >
            &lt;
          </button>
          <h2 id="currentMonthYear" class="text-xl font-semibold"></h2>
          <button
            id="nextMonth"
            class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
          >
            &gt;
          </button>
        </div>
        <div
          class="calendar-grid text-center font-semibold text-gray-600 dark:text-gray-400 mb-2"
        >
          <div>Dom</div>
          <div>Lun</div>
          <div>Mar</div>
          <div>Mié</div>
          <div>Jue</div>
          <div>Vie</div>
          <div>Sáb</div>
        </div>
        <div id="calendar" class="calendar-grid">
          <!-- El calendario se generará aquí -->
        </div>
      </div>
    </div>

    <!-- Modal para Agregar/Editar Medicamento -->
    <div
      id="medModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all scale-95 opacity-0"
        id="medModalContent"
      >
        <h3 id="modalTitle" class="text-2xl font-bold mb-6 text-center">
          Agregar Medicamento
        </h3>
        <form id="medForm">
          <input type="hidden" id="medId" />
          <div class="mb-4">
            <label
              for="medName"
              class="block text-gray-700 dark:text-gray-300 font-semibold mb-2"
              >Nombre del Medicamento</label
            >
            <input
              type="text"
              id="medName"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
              required
            />
          </div>
          <div class="mb-4">
            <label
              class="block text-gray-700 dark:text-gray-300 font-semibold mb-2"
              >Horarios de Dosis</label
            >
            <div id="dosesContainer" class="space-y-2">
              <!-- Los horarios se agregarán aquí -->
            </div>
            <button
              type="button"
              id="addDoseBtn"
              class="mt-2 text-sm text-teal-600 dark:text-teal-400 hover:text-teal-800 dark:hover:text-teal-300 font-semibold"
            >
              + Agregar Horario
            </button>
          </div>
          <div id="quantity-section" class="mb-4">
            <label
              for="medQuantity"
              class="block text-gray-700 dark:text-gray-300 font-semibold mb-2"
              >Cantidad Inicial (dosis)</label
            >
            <input
              type="number"
              id="medQuantity"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
              min="0"
            />
          </div>
          <div class="mb-4">
            <label
              for="medColor"
              class="block text-gray-700 dark:text-gray-300 font-semibold mb-2"
              >Color del Recordatorio</label
            >
            <input
              type="color"
              id="medColor"
              class="w-full h-10 px-1 py-1 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer"
              value="#22c55e"
              required
            />
          </div>
          <div class="mb-4">
            <label
              for="medNotes"
              class="block text-gray-700 dark:text-gray-300 font-semibold mb-2"
              >Notas (Opcional)</label
            >
            <textarea
              id="medNotes"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
              rows="3"
            ></textarea>
          </div>
          <div class="mb-4 border-t border-gray-200 dark:border-gray-700 pt-4">
            <label class="flex items-center space-x-2">
              <input
                type="checkbox"
                id="specificDaysToggle"
                class="h-4 w-4 rounded text-teal-500 focus:ring-teal-500"
              />
              <span class="text-gray-700 dark:text-gray-300 font-semibold"
                >Tomar solo en días específicos</span
              >
            </label>
          </div>
          <div id="daysOfWeek" class="hidden mb-6 flex justify-around">
            <!-- Los checkboxes de los días se mantienen igual, el estilo se aplica a la etiqueta -->
            <input
              type="checkbox"
              id="day-1"
              value="1"
              class="hidden day-checkbox"
            />
            <label
              for="day-1"
              class="cursor-pointer border-2 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 rounded-full w-10 h-10 flex items-center justify-center font-bold"
              >L</label
            >
            <input
              type="checkbox"
              id="day-2"
              value="2"
              class="hidden day-checkbox"
            />
            <label
              for="day-2"
              class="cursor-pointer border-2 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 rounded-full w-10 h-10 flex items-center justify-center font-bold"
              >M</label
            >
            <input
              type="checkbox"
              id="day-3"
              value="3"
              class="hidden day-checkbox"
            />
            <label
              for="day-3"
              class="cursor-pointer border-2 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 rounded-full w-10 h-10 flex items-center justify-center font-bold"
              >M</label
            >
            <input
              type="checkbox"
              id="day-4"
              value="4"
              class="hidden day-checkbox"
            />
            <label
              for="day-4"
              class="cursor-pointer border-2 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 rounded-full w-10 h-10 flex items-center justify-center font-bold"
              >J</label
            >
            <input
              type="checkbox"
              id="day-5"
              value="5"
              class="hidden day-checkbox"
            />
            <label
              for="day-5"
              class="cursor-pointer border-2 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 rounded-full w-10 h-10 flex items-center justify-center font-bold"
              >V</label
            >
            <input
              type="checkbox"
              id="day-6"
              value="6"
              class="hidden day-checkbox"
            />
            <label
              for="day-6"
              class="cursor-pointer border-2 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 rounded-full w-10 h-10 flex items-center justify-center font-bold"
              >S</label
            >
            <input
              type="checkbox"
              id="day-0"
              value="0"
              class="hidden day-checkbox"
            />
            <label
              for="day-0"
              class="cursor-pointer border-2 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 rounded-full w-10 h-10 flex items-center justify-center font-bold"
              >D</label
            >
          </div>
          <div class="flex justify-end space-x-4">
            <button
              type="button"
              id="cancelBtn"
              class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-6 rounded-lg transition-colors"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-lg transition-colors"
            >
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal de Confirmación de Toma -->
    <div
      id="confirmationModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center transform transition-all scale-95 opacity-0"
        id="confirmationModalContent"
      >
        <input type="hidden" id="confirmMedId" />
        <h3 class="text-2xl font-bold mb-4">¡Hora de tu medicina!</h3>
        <p
          id="confirmMedText"
          class="text-gray-600 dark:text-gray-400 mb-6 text-lg"
        ></p>
        <div class="flex justify-center space-x-2">
          <button
            id="snoozeBtn"
            class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg transition-colors"
          >
            Posponer 5 min
          </button>
          <button
            id="confirmTakenBtn"
            class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-colors"
          >
            ¡Tomada!
          </button>
          <button
            id="confirmSkipBtn"
            class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition-colors"
          >
            Omitir
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Historial del Día -->
    <div
      id="historyModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all scale-95 opacity-0"
        id="historyModalContent"
      >
        <h3 id="historyModalTitle" class="text-2xl font-bold mb-4 text-center">
          Historial del Día
        </h3>
        <div id="historyModalList" class="space-y-3 max-h-64 overflow-y-auto">
          <!-- El historial se insertará aquí dinámicamente -->
        </div>
        <div class="flex justify-end mt-6">
          <button
            type="button"
            id="closeHistoryBtn"
            class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-6 rounded-lg transition-colors"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Confirmar Borrado -->
    <div
      id="deleteConfirmModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center transform transition-all scale-95 opacity-0"
        id="deleteConfirmModalContent"
      >
        <h3 class="text-2xl font-bold mb-4 text-red-600">
          Confirmar Eliminación
        </h3>
        <p
          id="deleteConfirmText"
          class="text-gray-600 dark:text-gray-400 mb-6 text-lg"
        ></p>
        <div class="flex justify-center space-x-4">
          <button
            id="cancelDeleteBtn"
            class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-6 rounded-lg transition-colors"
          >
            Cancelar
          </button>
          <button
            id="confirmDeleteBtn"
            class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition-colors"
          >
            Eliminar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Confirmar Importación -->
    <div
      id="importConfirmModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center transform transition-all scale-95 opacity-0"
        id="importConfirmModalContent"
      >
        <h3 class="text-2xl font-bold mb-4 text-orange-600">
          Confirmar Importación
        </h3>
        <p class="text-gray-600 dark:text-gray-400 mb-6 text-lg">
          ¿Estás seguro de que quieres restaurar los datos? Esto sobreescribirá
          todos los datos actuales.
        </p>
        <div class="flex justify-center space-x-4">
          <button
            id="cancelImportBtn"
            class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-6 rounded-lg transition-colors"
          >
            Cancelar
          </button>
          <button
            id="confirmImportBtn"
            class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-lg transition-colors"
          >
            Restaurar
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Elementos del DOM
        const addMedBtn = document.getElementById("addMedBtn");
        const exportPdfBtn = document.getElementById("exportPdfBtn");
        const backupBtn = document.getElementById("backupBtn");
        const restoreBtn = document.getElementById("restoreBtn");
        const importFile = document.getElementById("importFile");
        const themeToggle = document.getElementById("theme-toggle");
        const themeIconLight = document.getElementById("theme-icon-light");
        const themeIconDark = document.getElementById("theme-icon-dark");

        const medModal = document.getElementById("medModal");
        const medModalContent = document.getElementById("medModalContent");
        const cancelBtn = document.getElementById("cancelBtn");
        const medForm = document.getElementById("medForm");
        const medicationList = document.getElementById("medicationList");
        const modalTitle = document.getElementById("modalTitle");
        const medIdInput = document.getElementById("medId");
        const medNameInput = document.getElementById("medName");
        const medColorInput = document.getElementById("medColor");
        const medQuantityInput = document.getElementById("medQuantity");
        const medNotesInput = document.getElementById("medNotes");
        const quantitySection = document.getElementById("quantity-section");
        const quantityLabel = document.querySelector(
          'label[for="medQuantity"]'
        );
        const specificDaysToggle =
          document.getElementById("specificDaysToggle");
        const daysOfWeekContainer = document.getElementById("daysOfWeek");
        const dosesContainer = document.getElementById("dosesContainer");
        const addDoseBtn = document.getElementById("addDoseBtn");
        const emptyState = document.getElementById("empty-state");

        // Modal de confirmación
        const confirmationModal = document.getElementById("confirmationModal");
        const confirmationModalContent = document.getElementById(
          "confirmationModalContent"
        );
        const confirmMedText = document.getElementById("confirmMedText");
        const confirmTakenBtn = document.getElementById("confirmTakenBtn");
        const snoozeBtn = document.getElementById("snoozeBtn");
        const confirmSkipBtn = document.getElementById("confirmSkipBtn");
        const confirmMedIdInput = document.getElementById("confirmMedId");

        // Modal de historial
        const historyModal = document.getElementById("historyModal");
        const historyModalContent = document.getElementById(
          "historyModalContent"
        );
        const historyModalTitle = document.getElementById("historyModalTitle");
        const historyModalList = document.getElementById("historyModalList");
        const closeHistoryBtn = document.getElementById("closeHistoryBtn");

        // Modal de confirmación de borrado
        const deleteConfirmModal =
          document.getElementById("deleteConfirmModal");
        const deleteConfirmModalContent = document.getElementById(
          "deleteConfirmModalContent"
        );
        const deleteConfirmText = document.getElementById("deleteConfirmText");
        const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
        const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

        // Modal de confirmación de importación
        const importConfirmModal =
          document.getElementById("importConfirmModal");
        const importConfirmModalContent = document.getElementById(
          "importConfirmModalContent"
        );
        const cancelImportBtn = document.getElementById("cancelImportBtn");
        const confirmImportBtn = document.getElementById("confirmImportBtn");

        // Calendario
        const calendarEl = document.getElementById("calendar");
        const currentMonthYearEl = document.getElementById("currentMonthYear");
        const prevMonthBtn = document.getElementById("prevMonth");
        const nextMonthBtn = document.getElementById("nextMonth");

        // Estado de la aplicación
        let medications = JSON.parse(localStorage.getItem("medications")) || [];
        let completedMeds =
          JSON.parse(localStorage.getItem("completedMeds")) || {};
        let currentDate = new Date();
        let notificationQueue = [];
        let dataToImport = null;

        // --- Lógica del Tema (Modo Oscuro) ---
        const applyTheme = (theme) => {
          if (theme === "dark") {
            document.documentElement.classList.add("dark");
            themeIconLight.classList.add("hidden");
            themeIconDark.classList.remove("hidden");
          } else {
            document.documentElement.classList.remove("dark");
            themeIconLight.classList.remove("hidden");
            themeIconDark.classList.add("hidden");
          }
          localStorage.setItem("theme", theme);
        };

        themeToggle.addEventListener("click", () => {
          const isDark = document.documentElement.classList.contains("dark");
          const newTheme = isDark ? "light" : "dark";
          applyTheme(newTheme);
        });

        // --- Lógica de Dosis ---
        const createTimeInput = (time = "") => {
          const div = document.createElement("div");
          div.className = "flex items-center space-x-2";
          const input = document.createElement("input");
          input.type = "time";
          input.className =
            "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500";
          input.value = time;
          input.required = true;
          div.appendChild(input);

          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.innerHTML =
            '<svg class="w-6 h-6 text-red-500 hover:text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
          removeBtn.onclick = () => {
            if (dosesContainer.children.length > 1) {
              div.remove();
            }
          };
          div.appendChild(removeBtn);
          dosesContainer.appendChild(div);
        };

        addDoseBtn.addEventListener("click", () => createTimeInput());

        // --- Lógica de Modales ---
        const openModal = (modal, content) => {
          modal.classList.remove("hidden");
          setTimeout(() => {
            content.classList.remove("scale-95", "opacity-0");
          }, 10);
        };

        const closeModal = (modal, content) => {
          content.classList.add("scale-95", "opacity-0");
          setTimeout(() => {
            modal.classList.add("hidden");
            if (modal === confirmationModal) {
              processNotificationQueue(); // Procesa la siguiente notificación en la cola
            }
          }, 200);
        };

        // Abrir modal de agregar medicamento
        addMedBtn.addEventListener("click", () => {
          modalTitle.textContent = "Agregar Medicamento";
          medForm.reset();
          medColorInput.value = "#22c55e";
          medIdInput.value = "";
          quantitySection.style.display = "block";
          quantityLabel.textContent = "Cantidad Inicial (dosis)";
          medQuantityInput.required = true;
          daysOfWeekContainer.classList.add("hidden");
          dosesContainer.innerHTML = "";
          createTimeInput();
          openModal(medModal, medModalContent);
        });

        // Cerrar modales
        cancelBtn.addEventListener("click", () =>
          closeModal(medModal, medModalContent)
        );
        confirmSkipBtn.addEventListener("click", () =>
          closeModal(confirmationModal, confirmationModalContent)
        );
        closeHistoryBtn.addEventListener("click", () =>
          closeModal(historyModal, historyModalContent)
        );
        cancelDeleteBtn.addEventListener("click", () =>
          closeModal(deleteConfirmModal, deleteConfirmModalContent)
        );
        cancelImportBtn.addEventListener("click", () =>
          closeModal(importConfirmModal, importConfirmModalContent)
        );

        medModal.addEventListener("click", (e) => {
          if (e.target === medModal) closeModal(medModal, medModalContent);
        });
        historyModal.addEventListener("click", (e) => {
          if (e.target === historyModal)
            closeModal(historyModal, historyModalContent);
        });
        deleteConfirmModal.addEventListener("click", (e) => {
          if (e.target === deleteConfirmModal)
            closeModal(deleteConfirmModal, deleteConfirmModalContent);
        });
        importConfirmModal.addEventListener("click", (e) => {
          if (e.target === importConfirmModal)
            closeModal(importConfirmModal, importConfirmModalContent);
        });

        specificDaysToggle.addEventListener("change", (e) => {
          if (e.target.checked) {
            daysOfWeekContainer.classList.remove("hidden");
          } else {
            daysOfWeekContainer.classList.add("hidden");
          }
        });

        // --- Lógica de Medicamentos (CRUD) ---
        const renderMedications = () => {
          medicationList.innerHTML = "";
          if (medications.length === 0) {
            medicationList.appendChild(emptyState);
            emptyState.style.display = "block";
          } else {
            emptyState.style.display = "none";
            const dayNames = ["D", "L", "M", "Mi", "J", "V", "S"];
            medications
              .sort((a, b) => a.times[0].localeCompare(b.times[0]))
              .forEach((med) => {
                const div = document.createElement("div");
                div.className =
                  "flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border border-gray-200 dark:border-gray-700";

                let quantityText = "";
                if (med.quantity !== undefined && med.quantity !== null) {
                  if (med.quantity <= 7) {
                    quantityText = `<span class="text-red-500 font-bold">Quedan: ${med.quantity} dosis ⚠️</span>`;
                  } else {
                    quantityText = `<span class="text-gray-600 dark:text-gray-400">Quedan: ${med.quantity} dosis</span>`;
                  }
                }

                let notesHTML = "";
                if (med.notes) {
                  notesHTML = `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1 italic overflow-hidden text-ellipsis whitespace-nowrap max-w-xs" title="${med.notes}">Nota: ${med.notes}</p>`;
                }

                let daysText = "Diario";
                if (med.days && med.days.length > 0) {
                  daysText =
                    "Días: " + med.days.map((d) => dayNames[d]).join(", ");
                }

                div.innerHTML = `
                            <div class="flex items-center">
                                <span class="w-4 h-4 rounded-full mr-3" style="background-color: ${
                                  med.color || "#22c55e"
                                };"></span>
                                <div class="overflow-hidden">
                                    <p class="font-semibold text-teal-700 dark:text-teal-400">${
                                      med.name
                                    }</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">${med.times.join(
                                      ", "
                                    )} - <span class="font-medium">${daysText}</span></p>
                                    <div class="text-sm mt-1">${quantityText}</div>
                                    ${notesHTML}
                                </div>
                            </div>
                            <div class="space-x-2 flex items-center flex-shrink-0">
                                <button data-id="${
                                  med.id
                                }" class="edit-btn text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 p-2 rounded-full hover:bg-blue-50 dark:hover:bg-blue-900/50 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                                </button>
                                <button data-id="${
                                  med.id
                                }" class="delete-btn text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/50 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        `;
                medicationList.appendChild(div);
              });
          }
        };

        medForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const id = medIdInput.value;
          const selectedDays = [];
          if (specificDaysToggle.checked) {
            daysOfWeekContainer
              .querySelectorAll("input:checked")
              .forEach((checkbox) => {
                selectedDays.push(parseInt(checkbox.value, 10));
              });
          }

          const times = Array.from(
            dosesContainer.querySelectorAll("input[type='time']")
          ).map((input) => input.value);

          if (id) {
            // Editar
            medications = medications.map((med) => {
              if (med.id == id) {
                return {
                  ...med,
                  name: medNameInput.value,
                  times: times,
                  color: medColorInput.value,
                  quantity: parseInt(medQuantityInput.value, 10),
                  notes: medNotesInput.value,
                  days: selectedDays,
                };
              }
              return med;
            });
          } else {
            // Crear
            const medData = {
              name: medNameInput.value,
              times: times,
              color: medColorInput.value,
              id: Date.now(),
              quantity: parseInt(medQuantityInput.value, 10),
              notes: medNotesInput.value,
              days: selectedDays,
            };
            medications.push(medData);
          }

          localStorage.setItem("medications", JSON.stringify(medications));
          renderMedications();
          closeModal(medModal, medModalContent);
        });

        medicationList.addEventListener("click", (e) => {
          const editBtn = e.target.closest(".edit-btn");
          const deleteBtn = e.target.closest(".delete-btn");

          if (editBtn) {
            const id = editBtn.dataset.id;
            const medToEdit = medications.find((med) => med.id == id);
            if (medToEdit) {
              modalTitle.textContent = "Editar Medicamento";
              medIdInput.value = medToEdit.id;
              medNameInput.value = medToEdit.name;

              dosesContainer.innerHTML = "";
              medToEdit.times.forEach((time) => createTimeInput(time));

              medColorInput.value = medToEdit.color || "#22c55e";
              quantityLabel.textContent = "Cantidad (dosis)";
              medQuantityInput.value = medToEdit.quantity;
              medNotesInput.value = medToEdit.notes || "";
              quantitySection.style.display = "block";
              medQuantityInput.required = true;

              // Populate days of week
              const hasSpecificDays =
                medToEdit.days && medToEdit.days.length > 0;
              specificDaysToggle.checked = hasSpecificDays;
              if (hasSpecificDays) {
                daysOfWeekContainer.classList.remove("hidden");
              } else {
                daysOfWeekContainer.classList.add("hidden");
              }
              daysOfWeekContainer.querySelectorAll("input").forEach((cb) => {
                cb.checked =
                  hasSpecificDays &&
                  medToEdit.days.includes(parseInt(cb.value, 10));
              });

              openModal(medModal, medModalContent);
            }
          }

          if (deleteBtn) {
            const id = deleteBtn.dataset.id;
            const medToDelete = medications.find((med) => med.id == id);
            if (medToDelete) {
              deleteConfirmText.innerHTML = `¿Estás seguro de que quieres eliminar <strong>${medToDelete.name}</strong>?`;
              confirmDeleteBtn.dataset.id = id; // Store id in the button
              openModal(deleteConfirmModal, deleteConfirmModalContent);
            }
          }
        });

        confirmDeleteBtn.addEventListener("click", () => {
          const id = confirmDeleteBtn.dataset.id;
          medications = medications.filter((med) => med.id != id);
          localStorage.setItem("medications", JSON.stringify(medications));
          renderMedications();
          closeModal(deleteConfirmModal, deleteConfirmModalContent);
        });

        const markMedAsTaken = (medId) => {
          const medIndex = medications.findIndex((m) => m.id == medId);
          if (medIndex === -1) return;

          const medTaken = medications[medIndex];

          // Decrement quantity
          if (
            medTaken.quantity !== undefined &&
            medTaken.quantity !== null &&
            medTaken.quantity > 0
          ) {
            medications[medIndex].quantity--;
            localStorage.setItem("medications", JSON.stringify(medications));
            renderMedications();
          }

          const now = new Date();
          const today = `${now.getFullYear()}-${(now.getMonth() + 1)
            .toString()
            .padStart(2, "0")}-${now.getDate().toString().padStart(2, "0")}`;
          const timeTaken = now.toLocaleTimeString("es-ES", {
            hour: "2-digit",
            minute: "2-digit",
          });

          if (!completedMeds[today]) {
            completedMeds[today] = [];
          }

          // Evita duplicados si se hace clic varias veces en el mismo minuto
          const alreadyTaken = completedMeds[today].some(
            (m) => m.id === medId && m.timeTaken === timeTaken
          );

          if (!alreadyTaken) {
            completedMeds[today].push({
              id: medId,
              color: medTaken.color,
              name: medTaken.name,
              timeTaken: timeTaken,
              notes: medTaken.notes,
            });
          }
          localStorage.setItem("completedMeds", JSON.stringify(completedMeds));
          renderCalendar();
        };

        // --- Lógica de Notificaciones ---
        const checkMedicationTime = () => {
          const now = new Date();
          const currentDay = now.getDay(); // 0 = Domingo, 1 = Lunes, etc.
          const currentTime = `${now
            .getHours()
            .toString()
            .padStart(2, "0")}:${now.getMinutes().toString().padStart(2, "0")}`;

          const lastCheckDate = localStorage.getItem("lastNotificationDate");
          const todayStr = `${now.getFullYear()}-${(now.getMonth() + 1)
            .toString()
            .padStart(2, "0")}-${now.getDate().toString().padStart(2, "0")}`;

          if (lastCheckDate !== todayStr) {
            localStorage.setItem("notifiedMedsToday", JSON.stringify([]));
            localStorage.setItem("lastNotificationDate", todayStr);
          }

          let notifiedMedsToday =
            JSON.parse(localStorage.getItem("notifiedMedsToday")) || [];

          medications.forEach((med) => {
            const isDaily = !med.days || med.days.length === 0;
            const isToday = med.days && med.days.includes(currentDay);

            if (isDaily || isToday) {
              med.times.forEach((time) => {
                const notificationId = `${med.id}-${time}`;
                if (
                  time === currentTime &&
                  !notifiedMedsToday.includes(notificationId)
                ) {
                  notificationQueue.push(med);
                  notifiedMedsToday.push(notificationId);
                }
              });
            }
          });

          if (notificationQueue.length > 0) {
            localStorage.setItem(
              "notifiedMedsToday",
              JSON.stringify(notifiedMedsToday)
            );
            processNotificationQueue(); // Procesa la cola
          }
        };

        const processNotificationQueue = () => {
          // Solo muestra un modal si no hay otro abierto y si hay elementos en la cola
          if (
            confirmationModal.classList.contains("hidden") &&
            notificationQueue.length > 0
          ) {
            const med = notificationQueue.shift(); // Saca el primer elemento
            showNotification(med);
          }
        };

        const showNotification = (med) => {
          const notificationText = `Es hora de tomar tu ${med.name}.`;

          if (Notification.permission === "granted") {
            new Notification("Recordatorio de Medicamento", {
              body: notificationText,
              icon: "https://cdn-icons-png.flaticon.com/512/893/893309.png",
            });
          }

          // Mostrar modal de confirmación
          confirmMedIdInput.value = med.id;
          confirmMedText.textContent = `¿Ya tomaste tu ${med.name}?`;
          openModal(confirmationModal, confirmationModalContent);
        };

        snoozeBtn.addEventListener("click", () => {
          const medId = confirmMedIdInput.value;
          const medToSnooze = medications.find((med) => med.id == medId);
          if (medToSnooze) {
            setTimeout(() => {
              showNotification(medToSnooze);
            }, 300000); // 5 minutos
          }
          closeModal(confirmationModal, confirmationModalContent);
        });

        confirmTakenBtn.addEventListener("click", () => {
          const medId = confirmMedIdInput.value;
          markMedAsTaken(medId);
          closeModal(confirmationModal, confirmationModalContent);
        });

        // --- Lógica del Calendario ---
        const showDayHistory = (dateStr) => {
          const date = new Date(dateStr + "T00:00:00");
          const options = {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          };
          historyModalTitle.textContent = `Historial del ${date.toLocaleDateString(
            "es-ES",
            options
          )}`;

          const medsForDay = completedMeds[dateStr] || [];
          historyModalList.innerHTML = "";

          if (medsForDay.length > 0) {
            medsForDay
              .sort((a, b) => a.timeTaken.localeCompare(b.timeTaken))
              .forEach((med) => {
                const div = document.createElement("div");
                div.className = "p-2 bg-gray-50 dark:bg-gray-700/50 rounded";

                let noteHistoryHTML = "";
                if (med.notes) {
                  noteHistoryHTML = `<p class="text-xs text-gray-500 dark:text-gray-400 italic mt-1">Nota: ${med.notes}</p>`;
                }

                div.innerHTML = `
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="completed-dot mr-3" style="background-color: ${med.color};"></span>
                                    <span>${med.name}</span>
                                </div>
                                <span class="font-semibold text-gray-600 dark:text-gray-400">${med.timeTaken} hs</span>
                            </div>
                            ${noteHistoryHTML}
                        `;
                historyModalList.appendChild(div);
              });
          } else {
            historyModalList.innerHTML =
              '<p class="text-center text-gray-500 dark:text-gray-400">No se registraron tomas este día.</p>';
          }

          openModal(historyModal, historyModalContent);
        };

        const renderCalendar = () => {
          calendarEl.innerHTML = "";
          const month = currentDate.getMonth();
          const year = currentDate.getFullYear();

          currentMonthYearEl.textContent = `${currentDate.toLocaleString(
            "es-ES",
            { month: "long" }
          )} ${year}`;

          const firstDayOfMonth = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();

          for (let i = 0; i < firstDayOfMonth; i++) {
            calendarEl.innerHTML += `<div class="bg-gray-50 dark:bg-gray-700/50 rounded"></div>`;
          }

          for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement("div");
            dayEl.className =
              "calendar-day p-2 border border-gray-200 dark:border-gray-700 rounded text-center";

            const dayStr = `${year}-${(month + 1)
              .toString()
              .padStart(2, "0")}-${day.toString().padStart(2, "0")}`;
            const today = new Date();
            if (
              day === today.getDate() &&
              month === today.getMonth() &&
              year === today.getFullYear()
            ) {
              dayEl.classList.add(
                "bg-teal-100",
                "dark:bg-teal-900/50",
                "font-bold"
              );
            }

            let dayContent = `<div>${day}</div>`;

            if (completedMeds[dayStr] && completedMeds[dayStr].length > 0) {
              dayEl.classList.add(
                "cursor-pointer",
                "hover:bg-gray-100",
                "dark:hover:bg-gray-700",
                "transition-colors"
              );
              dayEl.addEventListener("click", () => showDayHistory(dayStr));

              let dotsHTML =
                '<div class="mt-1 flex justify-center items-center space-x-1">';
              completedMeds[dayStr].forEach((completed) => {
                dotsHTML += `<span class="completed-dot" style="background-color: ${completed.color};"></span>`;
              });
              dotsHTML += "</div>";
              dayContent += dotsHTML;
            }
            dayEl.innerHTML = dayContent;
            calendarEl.appendChild(dayEl);
          }
        };

        prevMonthBtn.addEventListener("click", () => {
          currentDate.setMonth(currentDate.getMonth() - 1);
          renderCalendar();
        });

        nextMonthBtn.addEventListener("click", () => {
          currentDate.setMonth(currentDate.getMonth() + 1);
          renderCalendar();
        });

        const exportToPDF = () => {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          const margin = 10;
          let y = margin;

          doc.setFont("helvetica", "bold");
          doc.setFontSize(18);
          doc.text("Reporte de Medicamentos", margin, y);
          y += 10;

          doc.setFont("helvetica", "bold");
          doc.setFontSize(14);
          doc.text("Mis Medicamentos", margin, y);
          y += 8;

          doc.setFont("helvetica", "normal");
          doc.setFontSize(10);
          const dayNames = ["D", "L", "M", "Mi", "J", "V", "S"];

          medications.forEach((med) => {
            let daysText = "Diario";
            if (med.days && med.days.length > 0) {
              daysText = "Días: " + med.days.map((d) => dayNames[d]).join(", ");
            }

            doc.text(`- ${med.name}`, margin, y);
            y += 5;
            doc.text(`   Horarios: ${med.times.join(", ")}`, margin, y);
            y += 5;
            doc.text(`   Frecuencia: ${daysText}`, margin, y);
            y += 5;
            if (med.quantity !== null && med.quantity !== undefined) {
              doc.text(
                `   Cantidad restante: ${med.quantity} dosis`,
                margin,
                y
              );
              y += 5;
            }
            if (med.notes) {
              doc.text(`   Notas: ${med.notes}`, margin, y);
              y += 5;
            }
            y += 5;
          });

          y += 10;
          doc.setFont("helvetica", "bold");
          doc.setFontSize(14);
          doc.text(
            `Historial de Tomas - ${currentMonthYearEl.textContent}`,
            margin,
            y
          );
          y += 8;

          doc.setFont("helvetica", "normal");
          doc.setFontSize(10);

          const month = currentDate.getMonth();
          const year = currentDate.getFullYear();
          const daysInMonth = new Date(year, month + 1, 0).getDate();

          for (let day = 1; day <= daysInMonth; day++) {
            const dayStr = `${year}-${(month + 1)
              .toString()
              .padStart(2, "0")}-${day.toString().padStart(2, "0")}`;

            if (completedMeds[dayStr] && completedMeds[dayStr].length > 0) {
              doc.setFont("helvetica", "bold");
              doc.text(`Día ${day}:`, margin, y);
              y += 5;
              doc.setFont("helvetica", "normal");

              completedMeds[dayStr].forEach((med) => {
                doc.text(
                  `   - ${med.name} (Tomada a las ${med.timeTaken} hs)`,
                  margin,
                  y
                );
                y += 5;
                if (y > 280) {
                  // page break
                  doc.addPage();
                  y = margin;
                }
              });
            }
          }

          doc.save("Reporte_Medicamentos.pdf");
        };

        const exportData = () => {
          const dataToExport = {
            medications: medications,
            completedMeds: completedMeds,
          };
          const dataStr = JSON.stringify(dataToExport, null, 2);
          const dataBlob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "Pastillero_Backup.json";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        };

        const handleFileImport = (event) => {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const importedData = JSON.parse(e.target.result);
              if (importedData.medications && importedData.completedMeds) {
                dataToImport = importedData;
                openModal(importConfirmModal, importConfirmModalContent);
              } else {
                alert("El archivo de respaldo no tiene el formato correcto.");
              }
            } catch (error) {
              alert(
                "No se pudo leer el archivo. Asegúrate de que sea un archivo de respaldo válido."
              );
            }
          };
          reader.readAsText(file);
          importFile.value = "";
        };

        confirmImportBtn.addEventListener("click", () => {
          if (dataToImport) {
            medications = dataToImport.medications;
            completedMeds = dataToImport.completedMeds;
            localStorage.setItem("medications", JSON.stringify(medications));
            localStorage.setItem(
              "completedMeds",
              JSON.stringify(completedMeds)
            );
            renderMedications();
            renderCalendar();
          }
          closeModal(importConfirmModal, importConfirmModalContent);
          dataToImport = null;
        });

        backupBtn.addEventListener("click", exportData);
        restoreBtn.addEventListener("click", () => importFile.click());
        importFile.addEventListener("change", handleFileImport);
        exportPdfBtn.addEventListener("click", exportToPDF);

        // --- Inicialización ---
        const initialize = () => {
          const savedTheme = localStorage.getItem("theme");
          const prefersDark = window.matchMedia(
            "(prefers-color-scheme: dark)"
          ).matches;
          if (savedTheme) {
            applyTheme(savedTheme);
          } else if (prefersDark) {
            applyTheme("dark");
          } else {
            applyTheme("light");
          }

          renderMedications();
          renderCalendar();
          if (Notification.permission !== "granted") {
            Notification.requestPermission();
          }
          setInterval(checkMedicationTime, 15000); // Revisa cada 15 segundos
          checkMedicationTime(); // Revisa al cargar la página
        };

        initialize();
      });
    </script>
  </body>
</html>
